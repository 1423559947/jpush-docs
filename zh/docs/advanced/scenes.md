# 高级应用场景

### 每条消息需要确认收到

#### 业务场景

在某些场景中，比如企业办公类、订单状态通知，推送的消息需要确保用户一定收到；如果未能及时收到，则需要采取进一步的其他措施。

#### 问题解析

通过网络推送通知/消息，存在通知不能及时地到达用户手里的可能（因为手机原因、网络原因）。所以，需要能够很及时的检查确认客户端是否收到。

#### 解决思路

* JPush Report API 提供一条消息的送达统计。这个统计是实时的，可以在调用推送后立即调用这个 Report API 来检查，并且允许连续间隔一定时长多次检查；
* 开发者App 向自己的应用服务器反馈推送消息收到确认。

### 基于 JPush 实现聊天

#### 业务场景

App 里边加入实时聊天功能，越来越成为广泛的需求。

但是，完全自己去实现实时聊天，技术上有一定的复杂度，工作量上还是稍有点大。

#### 问题解析

JPush 提供的消息推送通道，可以解决 IM 聊天场景中主要的技术问题：实时向客户端推送消息。

但一般消息推送系统的离线消息是有限制的：

* 离线消息保存条数有限：JPush 默认是 5 条；
* 离线消息保留时长有限：JPush 默认是 1 天，最长 10 天。

对于聊天场景来说，根据实际需求的不同，可能导致上面 2 个参数需求更大。

#### 解决思路

JPush 为满足聊天场景的需求，提供一些功能定制以及补充。

App 基于 JPush 实现聊天功能，可以基于 JPush 的离线消息作为未读消息存储。在保留的条数与时长上，可以特别为 App 开放得更大。

如有此需求，请与商务沟通。

另外，JPush 也正在完善 PushTalk 项目，完全做成一个可直接拿来用的移动 IM 全套系统。敬请期待。

### 多帐户登录的离线消息

#### 业务场景

客户端App 是类QQ（聊天）客户端应用，支持多个帐号登录。

聊天帐号UID 设置为 JPush 别名，从而聊天用户之间可以通过别名互相推送消息。

A 帐号登录后（绑定 A uid 到别名），可以通过 JPush 向 A 推送消息。

A 退出后，登录 B（更新绑定 B uid 到别名）。这时候可以通过 JPush 向 B 推送消息。 但是：继续向 A 推送消息则会报错，通过别名 A uid 找不到目标用户。

#### 问题解析

JPush 别名是针对设备设置的。一台设备上，只能绑定一个别名。新的别名会覆盖，被覆盖掉的别名不再对应设备。

这是 JPush 的机制。

这个业务场景，想要在 A 用户没有注销的情况下，也可以向其推送消息，让 JPush 来保存离线消息，从而 A 再次登录时可以继续收到。

这个业务场景需求对 JPush 是过度依赖了。

JPush 只是做 “推送” 这个唯一的功能。JPush 提供有限时长的离线消息，它是推送机制的一部分，而不是为了保存消息历史记录。

如果开发者应用想要做历史消息记录功能，则应自己的应用服务器去做。

#### 解决思路

A 用户注销后，当有其他用户要向 A 用户发送消息时，开发者应用服务器应保存消息历史记录，而不要向 A 用户推送。只是 A 用户再次登录上线时，才可以向其推送消息。

### 多帐户登录的别名设置

#### 业务场景

客户端App支持多帐户登录。

每个用户登录时，都把该帐号UID设置为别名，从而接收到该用户的推送消息。

但有个问题：A 退出登录后，B 还未更新设置别名之前的发给 A 的推送消息，会被 B 收到。

#### 问题解析

别名是与本设备（本应用）绑定的。在 B 未设置别名成功之前，推送给 A 的信息都一直会被收到。

#### 解决思路

A 用户注销前，先做一个别名设置：把别名设置为空。

这样发给 A 的推送，将不会再给到本设置。

### Android / iOS 同时推送

```
说明：JPush 自定义消息支持IOS版本的前提是服务端是V3版本且客户端SDK版本要1.7.3及以上

```
#### 业务场景

```
当前是围绕使用v2版本的准则，升级版本后，下面的业务场景不存在推送方式的限制了。
```

开发者 App 有 Android / iOS 版本，在 JPush Web Portal 上也是同一个应用有 2 个 OS 版本。

推送时，有需要同一条消息，同时推送给 2 个平台。

由于 JPush 自定义消息当前不支持 iOS 版本，所以只能推送“通知”。

但是，有另外一个问题是：在 Android 上由于开发者想要定制通知效果，不想用默认的通知。所以在 Android 上是想要使用“自定义消息“的。

#### 问题解析

矛盾在于 Android 上最好用“自定义消息“，iOS 上只能使用“通知”。

但是，开发者自己推送前又不是很方便去确认用户是哪个平台的，否则调用 2 次 API 推送问题也不大，多一次 API 调用而已。

#### 解决思路

统一为 Android 也用通知。

但是，通知内容填空，则 Android 上通知就不展现出来，类似于“自定义消息”的效果。内容填在 extras 里，App 收到后再写到通知栏上。

